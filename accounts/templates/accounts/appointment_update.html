{% extends 'accounts/base.html' %}

{% block title %}Reschedule Appointment - Clinic Appointment{% endblock %}

{% block content %}
{% include 'accounts/patient_header.html' %}

<div class="container">
    <div class="auth-card" style="max-width: 600px; margin: 2rem auto;">
        <div class="mb-3">
            <h2>⟳ Reschedule Appointment</h2>
            <p class="text-muted">Change the time for your appointment.</p>
        </div>

        <form method="post">
            {% csrf_token %}

            <div class="form-group">
                <label class="form-label">Healthcare Provider</label>
                <div class="form-control" style="background-color: #f1f5f9; border-color: transparent;">
                    {{ appointment.provider.first_name }} {{ appointment.provider.last_name }}
                    <span class="text-muted">({{ appointment.provider.designation }})</span>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">New Date</label>
                <input type="date" id="date" name="date" value="{{ appointment.date }}" class="form-control" required>
            </div>

            <div style="display: flex; gap: 1rem;">
                <div class="form-group" style="flex: 1;">
                    <label class="form-label">New Start Time</label>
                    <input type="time" id="start_time" name="start_time" value="{{ appointment.start_time }}"
                        class="form-control" required onchange="validateTime()">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label class="form-label">New End Time</label>
                    <input type="time" id="end_time" name="end_time" value="{{ appointment.end_time }}"
                        class="form-control" required onchange="validateTime()">
                </div>
            </div>

            <button type="submit" class="btn btn-primary btn-block">Submit Reschedule Request</button>
        </form>
    </div>
</div>

<script>
    function loadValidation() {
        let today = new Date().toISOString().split("T")[0];
        let dateInput = document.getElementById("date");
        if (dateInput) dateInput.setAttribute("min", today);
    }

    function validateTime() {
        let start = document.getElementById("start_time").value;
        let end = document.getElementById("end_time").value;

        if (start && end && end <= start) {
            alert("❌ End time must be AFTER start time.");
            document.getElementById("end_time").value = "";
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        loadValidation();
    });
</script>

{% if success %}
<script>
    setTimeout(() => {
        alert("⟳ Reschedule request submitted successfully!");
        window.location.href = "{% url 'appointment_list' %}";
    }, 100);
</script>
{% endif %}

{% if error %}
<script>
    let e = "{{ error }}";
    let msg = "";
    if (e === "invalid") msg = "❌ Invalid date or time format.";
    else if (e === "past") msg = "❌ You cannot select a past date.";
    else if (e === "startpast") msg = "❌ Start time cannot be earlier than current time.";
    else if (e === "endbeforestart") msg = "❌ End time must be AFTER start time.";
    else if (e === "conflict") msg = "❌ You already have another appointment in this time range.";

    if (msg) setTimeout(() => alert(msg), 100);
</script>
{% endif %}
{% endblock %}